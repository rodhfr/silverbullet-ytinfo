var z=Object.defineProperty;var E=(e,t)=>{for(var o in t)z(e,o,{get:t[o],enumerable:!0})};function A(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let i=0;i<o;i++)n[i]=t.charCodeAt(i);return n}function x(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let n=0;n<o;n++)t+=String.fromCharCode(e[n]);return btoa(t)}var y=class{constructor(t="",o=1e3){this.prefix=t;this.maxCaptureSize=o;this.prefix=t,this.originalConsole={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console)},this.patchConsole()}originalConsole;logBuffer=[];patchConsole(){let t=o=>(...n)=>{let i=this.prefix?[this.prefix,...n]:n;this.originalConsole[o](...i),this.captureLog(o,n)};console.log=t("log"),console.info=t("info"),console.warn=t("warn"),console.error=t("error"),console.debug=t("debug")}captureLog(t,o){let n={level:t,timestamp:Date.now(),message:o.map(i=>{if(typeof i=="string")return i;try{return JSON.stringify(i)}catch{return String(i)}}).join(" ")};this.logBuffer.push(n),this.logBuffer.length>this.maxCaptureSize&&this.logBuffer.shift()}async postToServer(t,o){if(this.logBuffer.length>0){let i=[...this.logBuffer];this.logBuffer=[];try{if(!(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.map(c=>({...c,source:o})))})).ok)throw new Error("Failed to post logs to server")}catch(s){console.warn("Could not post logs to server",s.message),this.logBuffer.unshift(...i)}}}},I;function L(e=""){return I=new y(e),I}var d=e=>{throw new Error("Not initialized yet")},w=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var P=new Map,h=0;w&&(globalThis.syscall=async(e,...t)=>await new Promise((o,n)=>{h++,P.set(h,{resolve:o,reject:n}),d({type:"sys",id:h,name:e,args:t})}));function C(e,t,o){w&&(d=o,self.addEventListener("message",n=>{(async()=>{let i=n.data;switch(i.type){case"inv":{let s=e[i.name];if(!s)throw new Error(`Function not loaded: ${i.name}`);try{let c=await Promise.resolve(s(...i.args||[]));d({type:"invr",id:i.id,result:c})}catch(c){console.error("An exception was thrown as a result of invoking function",i.name,"error:",c.message),d({type:"invr",id:i.id,error:c.message})}}break;case"sysr":{let s=i.id,c=P.get(s);if(!c)throw Error("Invalid request id");P.delete(s),i.error?c.reject(new Error(i.error)):c.resolve(i.result)}break}})().catch(console.error)}),d({type:"manifest",manifest:t}),L(`[${t.name} plug]`))}async function G(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),n=o.length>0?x(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function J(){globalThis.fetch=async function(e,t){let o=t&&t.body?x(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await G(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(n.base64Body?A(n.base64Body):null,{status:n.status,headers:n.headers})}}w&&J();function v(e){let t=e*1e3;return new Promise(o=>setTimeout(o,t))}var a={};E(a,{alert:()=>Ue,configureVimMode:()=>Je,confirm:()=>Fe,copyToClipboard:()=>Ke,deleteLine:()=>Qe,dispatch:()=>De,downloadFile:()=>we,filterBox:()=>Te,flashNotification:()=>be,fold:()=>Ne,foldAll:()=>$e,getCurrentEditor:()=>re,getCurrentPage:()=>Z,getCurrentPageMeta:()=>X,getCurrentPath:()=>ee,getCursor:()=>ie,getRecentlyOpenedPages:()=>te,getSelection:()=>se,getText:()=>oe,getUiOption:()=>Oe,goHistory:()=>Pe,hidePanel:()=>Ae,insertAtCursor:()=>_e,insertAtPos:()=>Le,invokeCommand:()=>ce,isMobile:()=>Xe,moveCursor:()=>Se,moveCursorToLine:()=>Me,moveLineDown:()=>ze,moveLineUp:()=>Ye,navigate:()=>le,newWindow:()=>he,openCommandPalette:()=>pe,openPageNavigator:()=>de,openSearchPanel:()=>qe,openUrl:()=>ye,prompt:()=>We,rebuildEditorState:()=>ge,redo:()=>je,reloadConfigAndCommands:()=>xe,reloadPage:()=>fe,reloadUI:()=>me,replaceRange:()=>Ce,save:()=>ue,sendMessage:()=>Ze,setSelection:()=>ae,setText:()=>ne,setUiOption:()=>Re,showPanel:()=>Ee,showProgress:()=>Ie,toggleFold:()=>Be,undo:()=>He,unfold:()=>ke,unfoldAll:()=>Ve,uploadFile:()=>ve,vimEx:()=>Ge});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function Z(){return r("editor.getCurrentPage")}function X(){return r("editor.getCurrentPageMeta")}function ee(){return r("editor.getCurrentPath")}function te(){return r("editor.getRecentlyOpenedPages")}function re(){return r("editor.getCurrentEditor")}function oe(){return r("editor.getText")}function ne(e,t=!1){return r("editor.setText",e,t)}function ie(){return r("editor.getCursor")}function se(){return r("editor.getSelection")}function ae(e,t){return r("editor.setSelection",e,t)}function ce(e,t){return r("editor.invokeCommand",e,t)}function ue(){return r("editor.save")}function le(e,t=!1,o=!1){return r("editor.navigate",e,t,o)}function de(e="page"){return r("editor.openPageNavigator",e)}function pe(){return r("editor.openCommandPalette")}function fe(){return r("editor.reloadPage")}function me(){return r("editor.reloadUI")}function ge(){return r("editor.rebuildEditorState")}function xe(){return r("editor.reloadConfigAndCommands")}function ye(e,t=!1){return r("editor.openUrl",e,t)}function he(){return r("editor.newWindow")}function Pe(e){return r("editor.goHistory",e)}function we(e,t){return r("editor.downloadFile",e,t)}function ve(e,t){return r("editor.uploadFile",e,t)}function be(e,t="info"){return r("editor.flashNotification",e,t)}function Te(e,t,o="",n=""){return r("editor.filterBox",e,t,o,n)}function Ee(e,t,o,n=""){return r("editor.showPanel",e,t,o,n)}function Ae(e){return r("editor.hidePanel",e)}function Ie(e,t){return r("editor.showProgress",e,t)}function Le(e,t){return r("editor.insertAtPos",e,t)}function Ce(e,t,o){return r("editor.replaceRange",e,t,o)}function Se(e,t=!1){return r("editor.moveCursor",e,t)}function Me(e,t=1,o=!1){return r("editor.moveCursorToLine",e,t,o)}function _e(e,t=!1,o=!1){return r("editor.insertAtCursor",e,t,o)}function De(e){return r("editor.dispatch",e)}function We(e,t=""){return r("editor.prompt",e,t)}function Fe(e){return r("editor.confirm",e)}function Ue(e){return r("editor.alert",e)}function Oe(e){return r("editor.getUiOption",e)}function Re(e,t){return r("editor.setUiOption",e,t)}function Ne(){return r("editor.fold")}function ke(){return r("editor.unfold")}function Be(){return r("editor.toggleFold")}function $e(){return r("editor.foldAll")}function Ve(){return r("editor.unfoldAll")}function He(){return r("editor.undo")}function je(){return r("editor.redo")}function qe(){return r("editor.openSearchPanel")}function Ke(e){return r("editor.copyToClipboard",e)}function Qe(){return r("editor.deleteLine")}function Ye(){return r("editor.moveLineUp")}function ze(){return r("editor.moveLineDown")}function Ge(e){return r("editor.vimEx",e)}function Je(){return r("editor.configureVimMode")}function Ze(e,t){return r("editor.sendMessage",e,t)}function Xe(){return r("editor.isMobile")}var l={};E(l,{deleteDocument:()=>pt,deleteFile:()=>yt,deletePage:()=>st,fileExists:()=>ht,getDocumentMeta:()=>ut,getFileMeta:()=>gt,getPageMeta:()=>rt,listDocuments:()=>ct,listFiles:()=>ft,listPages:()=>tt,listPlugs:()=>at,pageExists:()=>ot,readDocument:()=>lt,readFile:()=>mt,readPage:()=>nt,writeDocument:()=>dt,writeFile:()=>xt,writePage:()=>it});function tt(){return r("space.listPages")}function rt(e){return r("space.getPageMeta",e)}function ot(e){return r("space.pageExists",e)}function nt(e){return r("space.readPage",e)}function it(e,t){return r("space.writePage",e,t)}function st(e){return r("space.deletePage",e)}function at(){return r("space.listPlugs")}function ct(){return r("space.listDocuments")}function ut(e){return r("space.getDocumentMeta",e)}function lt(e){return r("space.readDocument",e)}function dt(e,t){return r("space.writeDocument",e,t)}function pt(e){return r("space.deleteDocument",e)}function ft(){return r("space.listFiles")}function mt(e){return r("space.readFile",e)}function gt(e){return r("space.getFileMeta",e)}function xt(e,t){return r("space.writeFile",e,t)}function yt(e){return r("space.deleteFile",e)}function ht(e){return r("space.fileExists",e)}var f="https://inv.perditum.com/api/v1/videos/";var u="WATCHLIST";var S="300",M="default",_="44",D=" - ",W="#watch",F="- [ ] [${author}${char_separator}${title}](${url}) ${tag}",U="\n![thumbnail|${thumbnail_size}](${thumbnail})\n";function Ft(e){console.log("exec fn getYtID(): description: parses youtube video id using regex.");let t=/https?:\/\/(?:www\.)?([^\/]+)/,o=e.match(t);if(!o)return null;let n=o[1].toLowerCase();if(!n.includes("youtube.com")&&!n.includes("youtu.be"))return null;let i=e.match(/youtu\.be\/([\w-]{11})/);if(i)return i[1];let s=e.match(/[?&]v=([\w-]{11})/);if(s)return s[1];let c=e.match(/\/shorts\/([\w-]{11})/);return c?c[1]:null}async function O(e){console.log("exec async fn: getVideoInfo(): description: Requests info using invidious api.");let t=Ft(e),o;f.endsWith("/")?o=f+t:o=f+"/"+t;try{let n=await fetch(o);if(!n.ok)throw new Error("fn: getVideoInfo(): Network response error.");return await n.json()}catch(n){return console.error("fn: getVideoInfo(): Error fetching data.",n),null}}function b(e,t){return console.log("exec fn expandTemplate(): description: takes the user provided formatting and uses it."),e.replace(/\$\{(\w+)\}/g,(o,n)=>t[n]??"")}function R(e,t){return console.log("exec fn elipsisTitle(): description: truncates title if it exceeds limit."),e.length>t&&t>3?(console.log(`fn elipsisTitle(): Title exceeded elipsis limit of ${t} characters. Applied truncation.`),e.substring(0,t-3)+"..."):e}async function k(){let e=await a.prompt("Enter YouTube URL:","");if(!e){console.error("fn newWatch(): invalid URL provided, aborting."),a.flashNotification("Invalid URL provided.");return}a.flashNotification("Adding YouTube video...");let t=await O(e);if(!t){console.error("fn newWatch(): No data received from getVideoInfo()."),a.flashNotification("Failed to fetch video info.");return}let{title:o,author:n,description:i}=t,s=o.replace(/#/g,"\\#"),c=parseInt(_);s=R(s,c);let p=b(F,{title:s,url:e,author:n,description:i,char_separator:D,tag:W});if(console.log(`$VIDEO_THUMBNAIL = ${!0} in config.ts`),!!0&&!!0){console.log("fn newWatch(): VIDEO_THUMBNAIL is false, WATCHLIST_ENABLE false. Skipping thumbnail write and watchlist file write..."),a.insertAtCursor(p),await a.flashNotification(`\u{1F3AC} ${n} - ${s} added with sucess!`);return}console.log("fn newWatch(): Writing video thumbnail...");let q={default:4,high:1,low:5}[M]??4,K=t.videoThumbnails[q].url,m=b(U,{thumbnail:K,thumbnail_size:S});if(!!0){console.log("fn newWatch(): WATCHLIST_ENABLE is false, inserting at cursor..."),await a.insertAtCursor(`${p}${m}`),await a.flashNotification(`\u{1F3AC} ${n} - ${s} added with sucess!`);return}if(console.log(`fn newWatch(): $WATCHLIST_ENABLE = ${!0}, adding to watchlist...`),a.flashNotification("Saving watchlist to "+u),!await l.pageExists(u)){console.log(`fn newWatch(): Watchlist page does not exist in ${u}, creating...`);let g=await l.writePage(u,`
${p}${m}`);console.log("fn newWatch(): Wrote page metadata:",g),await a.flashNotification(`\u{1F3AC} ${n} - ${s} added with sucess!`);return}console.log(`fn newWatch(): Watchlist page exists in ${u}, reading...`);let Q=await l.readPage(u),Y=await l.writePage(u,`${Q}
${p}${m}`).then(()=>{console.log("fn newWatch(): Wrote page metadata:",Y),a.flashNotification(`\u{1F3AC} ${n} - ${s} added with sucess!`)}).catch(g=>{console.error("fn newWatch(): Error writing to watchlist.",g),a.flashNotification(`Failed to add ${n} - ${s} to watchlist.`)})}function B(){console.log("exec fn deleteWatchlist(): description: Deletes the watchlist page."),l.deletePage(u).then(()=>{a.flashNotification("Watchlist deleted successfully.")}).catch(e=>{console.error("fn deleteWatchlist(): Error deleting watchlist.",e),a.flashNotification("Failed to delete watchlist.")})}async function $(){await k(),await v(3),await a.reloadPage()}async function V(){await B(),await v(3),await a.reloadPage()}var H={NewWatch:$,DeleteWatch:V},j={name:"ytinfo",version:.11,requiredPermissions:["fetch"],functions:{NewWatch:{path:"ytinfo.ts:newWatch",command:{name:"Youtube: New Watch"}},DeleteWatch:{path:"ytinfo.ts:deleteWatch",command:{name:"Youtube: Delete All Watchlist"}}},assets:{}},Sr={manifest:j,functionMapping:H};C(H,j,self.postMessage);export{Sr as plug};
