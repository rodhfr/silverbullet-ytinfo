var I=Object.defineProperty;var k=(e,t)=>{for(var o in t)I(e,o,{get:t[o],enumerable:!0})};function P(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let i=0;i<o;i++)n[i]=t.charCodeAt(i);return n}function m(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let n=0;n<o;n++)t+=String.fromCharCode(e[n]);return btoa(t)}var p=class{constructor(t="",o=1e3){this.prefix=t;this.maxCaptureSize=o;this.prefix=t,this.originalConsole={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console)},this.patchConsole()}originalConsole;logBuffer=[];patchConsole(){let t=o=>(...n)=>{let i=this.prefix?[this.prefix,...n]:n;this.originalConsole[o](...i),this.captureLog(o,n)};console.log=t("log"),console.info=t("info"),console.warn=t("warn"),console.error=t("error"),console.debug=t("debug")}captureLog(t,o){let n={level:t,timestamp:Date.now(),message:o.map(i=>{if(typeof i=="string")return i;try{return JSON.stringify(i)}catch{return String(i)}}).join(" ")};this.logBuffer.push(n),this.logBuffer.length>this.maxCaptureSize&&this.logBuffer.shift()}async postToServer(t,o){if(this.logBuffer.length>0){let i=[...this.logBuffer];this.logBuffer=[];try{if(!(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.map(s=>({...s,source:o})))})).ok)throw new Error("Failed to post logs to server")}catch(u){console.warn("Could not post logs to server",u.message),this.logBuffer.unshift(...i)}}}},h;function v(e=""){return h=new p(e),h}var c=e=>{throw new Error("Not initialized yet")},y=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var g=new Map,f=0;y&&(globalThis.syscall=async(e,...t)=>await new Promise((o,n)=>{f++,g.set(f,{resolve:o,reject:n}),c({type:"sys",id:f,name:e,args:t})}));function b(e,t,o){y&&(c=o,self.addEventListener("message",n=>{(async()=>{let i=n.data;switch(i.type){case"inv":{let u=e[i.name];if(!u)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(u(...i.args||[]));c({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),c({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let u=i.id,s=g.get(u);if(!s)throw Error("Invalid request id");g.delete(u),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),c({type:"manifest",manifest:t}),v(`[${t.name} plug]`))}async function _(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),n=o.length>0?m(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function O(){globalThis.fetch=async function(e,t){let o=t&&t.body?m(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await _(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(n.base64Body?P(n.base64Body):null,{status:n.status,headers:n.headers})}}y&&O();var a={};k(a,{alert:()=>ve,configureVimMode:()=>Oe,confirm:()=>he,copyToClipboard:()=>Le,deleteLine:()=>Ue,dispatch:()=>xe,downloadFile:()=>ie,filterBox:()=>ue,flashNotification:()=>ae,fold:()=>Te,foldAll:()=>Ee,getCurrentEditor:()=>$,getCurrentPage:()=>R,getCurrentPageMeta:()=>B,getCurrentPath:()=>N,getCursor:()=>W,getRecentlyOpenedPages:()=>V,getSelection:()=>K,getText:()=>j,getUiOption:()=>be,goHistory:()=>ne,hidePanel:()=>le,insertAtCursor:()=>ye,insertAtPos:()=>me,invokeCommand:()=>Q,isMobile:()=>Be,moveCursor:()=>fe,moveCursorToLine:()=>ge,moveLineDown:()=>ke,moveLineUp:()=>Ie,navigate:()=>z,newWindow:()=>oe,openCommandPalette:()=>J,openPageNavigator:()=>G,openSearchPanel:()=>Fe,openUrl:()=>re,prompt:()=>Pe,rebuildEditorState:()=>ee,redo:()=>De,reloadConfigAndCommands:()=>te,reloadPage:()=>Z,reloadUI:()=>X,replaceRange:()=>pe,save:()=>Y,sendMessage:()=>Re,setSelection:()=>H,setText:()=>q,setUiOption:()=>we,showPanel:()=>ce,showProgress:()=>de,toggleFold:()=>Me,undo:()=>Ae,unfold:()=>Ce,unfoldAll:()=>Se,uploadFile:()=>se,vimEx:()=>_e});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function R(){return r("editor.getCurrentPage")}function B(){return r("editor.getCurrentPageMeta")}function N(){return r("editor.getCurrentPath")}function V(){return r("editor.getRecentlyOpenedPages")}function $(){return r("editor.getCurrentEditor")}function j(){return r("editor.getText")}function q(e,t=!1){return r("editor.setText",e,t)}function W(){return r("editor.getCursor")}function K(){return r("editor.getSelection")}function H(e,t){return r("editor.setSelection",e,t)}function Q(e,t){return r("editor.invokeCommand",e,t)}function Y(){return r("editor.save")}function z(e,t=!1,o=!1){return r("editor.navigate",e,t,o)}function G(e="page"){return r("editor.openPageNavigator",e)}function J(){return r("editor.openCommandPalette")}function Z(){return r("editor.reloadPage")}function X(){return r("editor.reloadUI")}function ee(){return r("editor.rebuildEditorState")}function te(){return r("editor.reloadConfigAndCommands")}function re(e,t=!1){return r("editor.openUrl",e,t)}function oe(){return r("editor.newWindow")}function ne(e){return r("editor.goHistory",e)}function ie(e,t){return r("editor.downloadFile",e,t)}function se(e,t){return r("editor.uploadFile",e,t)}function ae(e,t="info"){return r("editor.flashNotification",e,t)}function ue(e,t,o="",n=""){return r("editor.filterBox",e,t,o,n)}function ce(e,t,o,n=""){return r("editor.showPanel",e,t,o,n)}function le(e){return r("editor.hidePanel",e)}function de(e,t){return r("editor.showProgress",e,t)}function me(e,t){return r("editor.insertAtPos",e,t)}function pe(e,t,o){return r("editor.replaceRange",e,t,o)}function fe(e,t=!1){return r("editor.moveCursor",e,t)}function ge(e,t=1,o=!1){return r("editor.moveCursorToLine",e,t,o)}function ye(e,t=!1,o=!1){return r("editor.insertAtCursor",e,t,o)}function xe(e){return r("editor.dispatch",e)}function Pe(e,t=""){return r("editor.prompt",e,t)}function he(e){return r("editor.confirm",e)}function ve(e){return r("editor.alert",e)}function be(e){return r("editor.getUiOption",e)}function we(e,t){return r("editor.setUiOption",e,t)}function Te(){return r("editor.fold")}function Ce(){return r("editor.unfold")}function Me(){return r("editor.toggleFold")}function Ee(){return r("editor.foldAll")}function Se(){return r("editor.unfoldAll")}function Ae(){return r("editor.undo")}function De(){return r("editor.redo")}function Fe(){return r("editor.openSearchPanel")}function Le(e){return r("editor.copyToClipboard",e)}function Ue(){return r("editor.deleteLine")}function Ie(){return r("editor.moveLineUp")}function ke(){return r("editor.moveLineDown")}function _e(e){return r("editor.vimEx",e)}function Oe(){return r("editor.configureVimMode")}function Re(e,t){return r("editor.sendMessage",e,t)}function Be(){return r("editor.isMobile")}var l="https://inv.perditum.com/api/v1/videos/";var w="300",T="- [ ] [${title}](${url}) #watch ",C="![thumbnail|${thumbnail_size}](${thumbnail})\n";function rt(e){console.log("getYtID()");let t=/https?:\/\/([^\/]+)/,o=e.match(t);if(!o||!o[1].includes("youtube.com"))return null;let n=/v=([\w-]{11})/,i=e.match(n);return i?i[1]:null}async function ot(e){console.log("getVideoInfo()");let t=rt(e),o=l.endsWith("/")?l+t:l+"/"+t;try{let n=await fetch(o);if(!n.ok)throw new Error("Network response was not ok");return await n.json()}catch(n){return console.error("Error fetching data:",n),null}}function E(e,t){return e.replace(/\$\{(\w+)\}/g,(o,n)=>t[n]??"")}async function S(){let e=await a.prompt("Enter YouTube URL:","");if(!e)return;a.flashNotification("Adding YouTube video...");let t=await ot(e);if(t){let n=t.title.replace(/#/g,"\\#"),i=n.length,u=t.author,s=t.description,F=E(T,{title:n,url:e});if(await a.insertAtCursor(F),console.log(`$VIDEO_THUMBNAIL = ${!0} in config.ts`),!0){console.log("Writing thumbnail...");let L=w,U=t.videoThumbnails[0].url,x=E(C,{thumbnail:U,thumbnail_size:L});if(i>36&&i<64){console.log(`$title len: ${i} fixing with $formatting_spaces`);let d=" ".repeat(29);console.log(d),console.log(`$formatting_spaces: ${d.length}`),await a.insertAtCursor(`${d}${x}`)}else console.log(`$title len: ${i} does not need format fix.`),await a.insertAtCursor(x)}await a.flashNotification(`\u{1F3AC} ${n} added!`)}else await a.flashNotification("Failed to fetch video info")}var A={NewWatch:S},D={name:"ytinfo",version:.3,requiredPermissions:["fetch"],functions:{NewWatch:{path:"ytinfo.ts:newWatch",command:{name:"Youtube: New Watch"}}},assets:{}},Vt={manifest:D,functionMapping:A};b(A,D,self.postMessage);export{Vt as plug};
