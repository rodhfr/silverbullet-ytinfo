var J=Object.defineProperty;var x=(e,t)=>{for(var o in t)J(e,o,{get:t[o],enumerable:!0})};function C(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let i=0;i<o;i++)n[i]=t.charCodeAt(i);return n}function P(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let n=0;n<o;n++)t+=String.fromCharCode(e[n]);return btoa(t)}var v=class{constructor(t="",o=1e3){this.prefix=t;this.maxCaptureSize=o;this.prefix=t,this.originalConsole={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console)},this.patchConsole()}originalConsole;logBuffer=[];patchConsole(){let t=o=>(...n)=>{let i=this.prefix?[this.prefix,...n]:n;this.originalConsole[o](...i),this.captureLog(o,n)};console.log=t("log"),console.info=t("info"),console.warn=t("warn"),console.error=t("error"),console.debug=t("debug")}captureLog(t,o){let n={level:t,timestamp:Date.now(),message:o.map(i=>{if(typeof i=="string")return i;try{return JSON.stringify(i)}catch{return String(i)}}).join(" ")};this.logBuffer.push(n),this.logBuffer.length>this.maxCaptureSize&&this.logBuffer.shift()}async postToServer(t,o){if(this.logBuffer.length>0){let i=[...this.logBuffer];this.logBuffer=[];try{if(!(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.map(c=>({...c,source:o})))})).ok)throw new Error("Failed to post logs to server")}catch(s){console.warn("Could not post logs to server",s.message),this.logBuffer.unshift(...i)}}}},M;function _(e=""){return M=new v(e),M}var f=e=>{throw new Error("Not initialized yet")},T=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var b=new Map,w=0;T&&(globalThis.syscall=async(e,...t)=>await new Promise((o,n)=>{w++,b.set(w,{resolve:o,reject:n}),f({type:"sys",id:w,name:e,args:t})}));function D(e,t,o){T&&(f=o,self.addEventListener("message",n=>{(async()=>{let i=n.data;switch(i.type){case"inv":{let s=e[i.name];if(!s)throw new Error(`Function not loaded: ${i.name}`);try{let c=await Promise.resolve(s(...i.args||[]));f({type:"invr",id:i.id,result:c})}catch(c){console.error("An exception was thrown as a result of invoking function",i.name,"error:",c.message),f({type:"invr",id:i.id,error:c.message})}}break;case"sysr":{let s=i.id,c=b.get(s);if(!c)throw Error("Invalid request id");b.delete(s),i.error?c.reject(new Error(i.error)):c.resolve(i.result)}break}})().catch(console.error)}),f({type:"manifest",manifest:t}),_(`[${t.name} plug]`))}async function X(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),n=o.length>0?P(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function ee(){globalThis.fetch=async function(e,t){let o=t&&t.body?P(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await X(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(n.base64Body?C(n.base64Body):null,{status:n.status,headers:n.headers})}}T&&ee();var a={};x(a,{alert:()=>Ne,configureVimMode:()=>et,confirm:()=>Oe,copyToClipboard:()=>ze,deleteLine:()=>Ge,dispatch:()=>Fe,downloadFile:()=>Te,filterBox:()=>Ae,flashNotification:()=>Ee,fold:()=>ke,foldAll:()=>qe,getCurrentEditor:()=>ie,getCurrentPage:()=>te,getCurrentPageMeta:()=>re,getCurrentPath:()=>oe,getCursor:()=>ce,getRecentlyOpenedPages:()=>ne,getSelection:()=>ue,getText:()=>se,getUiOption:()=>$e,goHistory:()=>be,hidePanel:()=>Se,insertAtCursor:()=>We,insertAtPos:()=>Me,invokeCommand:()=>de,isMobile:()=>rt,moveCursor:()=>De,moveCursorToLine:()=>Ue,moveLineDown:()=>Je,moveLineUp:()=>Ze,navigate:()=>pe,newWindow:()=>we,openCommandPalette:()=>ge,openPageNavigator:()=>me,openSearchPanel:()=>Ye,openUrl:()=>ve,prompt:()=>Re,rebuildEditorState:()=>xe,redo:()=>Qe,reloadConfigAndCommands:()=>Pe,reloadPage:()=>he,reloadUI:()=>ye,replaceRange:()=>_e,save:()=>fe,sendMessage:()=>tt,setSelection:()=>le,setText:()=>ae,setUiOption:()=>Ve,showPanel:()=>Le,showProgress:()=>Ce,toggleFold:()=>He,undo:()=>Ke,unfold:()=>Be,unfoldAll:()=>je,uploadFile:()=>Ie,vimEx:()=>Xe});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function te(){return r("editor.getCurrentPage")}function re(){return r("editor.getCurrentPageMeta")}function oe(){return r("editor.getCurrentPath")}function ne(){return r("editor.getRecentlyOpenedPages")}function ie(){return r("editor.getCurrentEditor")}function se(){return r("editor.getText")}function ae(e,t=!1){return r("editor.setText",e,t)}function ce(){return r("editor.getCursor")}function ue(){return r("editor.getSelection")}function le(e,t){return r("editor.setSelection",e,t)}function de(e,t){return r("editor.invokeCommand",e,t)}function fe(){return r("editor.save")}function pe(e,t=!1,o=!1){return r("editor.navigate",e,t,o)}function me(e="page"){return r("editor.openPageNavigator",e)}function ge(){return r("editor.openCommandPalette")}function he(){return r("editor.reloadPage")}function ye(){return r("editor.reloadUI")}function xe(){return r("editor.rebuildEditorState")}function Pe(){return r("editor.reloadConfigAndCommands")}function ve(e,t=!1){return r("editor.openUrl",e,t)}function we(){return r("editor.newWindow")}function be(e){return r("editor.goHistory",e)}function Te(e,t){return r("editor.downloadFile",e,t)}function Ie(e,t){return r("editor.uploadFile",e,t)}function Ee(e,t="info"){return r("editor.flashNotification",e,t)}function Ae(e,t,o="",n=""){return r("editor.filterBox",e,t,o,n)}function Le(e,t,o,n=""){return r("editor.showPanel",e,t,o,n)}function Se(e){return r("editor.hidePanel",e)}function Ce(e,t){return r("editor.showProgress",e,t)}function Me(e,t){return r("editor.insertAtPos",e,t)}function _e(e,t,o){return r("editor.replaceRange",e,t,o)}function De(e,t=!1){return r("editor.moveCursor",e,t)}function Ue(e,t=1,o=!1){return r("editor.moveCursorToLine",e,t,o)}function We(e,t=!1,o=!1){return r("editor.insertAtCursor",e,t,o)}function Fe(e){return r("editor.dispatch",e)}function Re(e,t=""){return r("editor.prompt",e,t)}function Oe(e){return r("editor.confirm",e)}function Ne(e){return r("editor.alert",e)}function $e(e){return r("editor.getUiOption",e)}function Ve(e,t){return r("editor.setUiOption",e,t)}function ke(){return r("editor.fold")}function Be(){return r("editor.unfold")}function He(){return r("editor.toggleFold")}function qe(){return r("editor.foldAll")}function je(){return r("editor.unfoldAll")}function Ke(){return r("editor.undo")}function Qe(){return r("editor.redo")}function Ye(){return r("editor.openSearchPanel")}function ze(e){return r("editor.copyToClipboard",e)}function Ge(){return r("editor.deleteLine")}function Ze(){return r("editor.moveLineUp")}function Je(){return r("editor.moveLineDown")}function Xe(e){return r("editor.vimEx",e)}function et(){return r("editor.configureVimMode")}function tt(e,t){return r("editor.sendMessage",e,t)}function rt(){return r("editor.isMobile")}var l={};x(l,{deleteDocument:()=>gt,deleteFile:()=>vt,deletePage:()=>ut,fileExists:()=>wt,getDocumentMeta:()=>ft,getFileMeta:()=>xt,getPageMeta:()=>it,listDocuments:()=>dt,listFiles:()=>ht,listPages:()=>nt,listPlugs:()=>lt,pageExists:()=>st,readDocument:()=>pt,readFile:()=>yt,readPage:()=>at,writeDocument:()=>mt,writeFile:()=>Pt,writePage:()=>ct});function nt(){return r("space.listPages")}function it(e){return r("space.getPageMeta",e)}function st(e){return r("space.pageExists",e)}function at(e){return r("space.readPage",e)}function ct(e,t){return r("space.writePage",e,t)}function ut(e){return r("space.deletePage",e)}function lt(){return r("space.listPlugs")}function dt(){return r("space.listDocuments")}function ft(e){return r("space.getDocumentMeta",e)}function pt(e){return r("space.readDocument",e)}function mt(e,t){return r("space.writeDocument",e,t)}function gt(e){return r("space.deleteDocument",e)}function ht(){return r("space.listFiles")}function yt(e){return r("space.readFile",e)}function xt(e){return r("space.getFileMeta",e)}function Pt(e,t){return r("space.writeFile",e,t)}function vt(e){return r("space.deleteFile",e)}function wt(e){return r("space.fileExists",e)}var p={};x(p,{getConfig:()=>Ct,getMode:()=>Lt,getVersion:()=>St,invokeCommand:()=>Tt,invokeFunction:()=>bt,listCommands:()=>It,listSyscalls:()=>Et,reloadPlugs:()=>At,wipeClient:()=>Mt});function bt(e,...t){return r("system.invokeFunction",e,...t)}function Tt(e,t){return r("system.invokeCommand",e,t)}function It(){return r("system.listCommands")}function Et(){return r("system.listSyscalls")}function At(){return r("system.reloadPlugs")}function Lt(){return r("system.getMode")}function St(){return r("system.getVersion")}function Ct(e,t=void 0){return r("system.getConfig",e,t)}function Mt(e=!1){return r("system.wipeClient",e)}var U=["https://inv.rodhfr.shop/api/v1/videos/","https://inv.perditum.com/api/v1/videos/"];var u="WATCHLIST";var W="300",F="default",R="44",O=" - ",N="#watch",$="- [ ] [${author}${char_separator}${title}](${url}) ${tag}",V="\n![thumbnail|${thumbnail_size}](${thumbnail})\n";function jt(e){console.log("exec fn getYtID(): description: parses youtube video id using regex.");let t=/https?:\/\/(?:www\.)?([^\/]+)/,o=e.match(t);if(!o)return null;let n=o[1].toLowerCase();if(!n.includes("youtube.com")&&!n.includes("youtu.be"))return null;let i=e.match(/[?&]v=([\w-]{11})/);if(i)return i[1];let s=e.match(/youtu\.be\/([\w-]{11})/);if(s)return s[1];let c=e.match(/[?&]v=([\w-]{11})/);if(c)return c[1];let d=e.match(/\/shorts\/([\w-]{11})/);return d?d[1]:null}async function k(e){console.log("exec async fn: getVideoInfo(): description: Requests info using invidious api.");let t=jt(e);for(let o of U){let n=o.endsWith("/")?o+t:o+"/"+t;console.log(`fn: getVideoInfo(): Fetching from Invidious API URL: ${n}`);try{let i=await fetch(n);if(!i.ok)throw new Error("Network response error.");let s=await i.json();if(!s||!s.title)throw new Error("Invalid data received from Invidious API.");return[s,o]}catch(i){console.error(`fn: getVideoInfo(): Error fetching from ${o}.`,i);continue}}throw new Error("fn: getVideoInfo(): All Invidious API URLs failed.")}function I(e,t){return console.log("exec fn expandTemplate(): description: takes the user provided formatting and uses it."),e.replace(/\$\{(\w+)\}/g,(o,n)=>t[n]??"")}function B(e,t){return console.log("exec fn elipsisTitle(): description: truncates title if it exceeds limit."),e.length>t&&t>3?(console.log(`fn elipsisTitle(): Title exceeded elipsis limit of ${t} characters. Applied truncation.`),e.substring(0,t-3)+"..."):e}async function q(){let e=await a.prompt("Enter YouTube URL:","");if(!e){console.error("fn newWatch(): invalid URL provided, aborting."),a.flashNotification("Invalid URL provided.");return}a.flashNotification("Adding YouTube video...");let[t,o]=await k(e);if(!t){console.error("fn newWatch(): No data received from getVideoInfo()."),a.flashNotification("Failed to fetch video info.");return}let n=t.title.replace(/#/g,"\\#"),i=t.author.replace(/#/g,"\\#"),s=t.description.replace(/#/g,"\\#"),c=parseInt(R);n=B(n,c);let d=I($,{title:n,url:e,author:i,description:s,char_separator:O,tag:N});if(console.log(`$VIDEO_THUMBNAIL = ${!0} in config.ts`),!!0&&!!0){console.log("fn newWatch(): VIDEO_THUMBNAIL is false, WATCHLIST_ENABLE false. Skipping thumbnail write and watchlist file write..."),a.insertAtCursor(d),await a.flashNotification(`\u{1F3AC} ${i} - ${n} added with sucess!`);return}console.log("fn newWatch(): Writing video thumbnail...");let m={high:"maxresdefault",default:"medium",low:"default"}[F]||"medium";console.log(`fn newWatch(): Using thumbnail quality: ${m} from Invidious API: ${o}`);let A=t.videoThumbnails,L=A.find(y=>y.quality===m);if(console.log("fn newWatch(): Available thumbnails:",A),!L)throw new Error(`fn newWatch(): Thumbnail with quality ${m} not found.`);let G=L.url,S=new URL(G,o).href;console.log(`fn newWatch(): Selected thumbnail URL: ${S}`);let g=parseInt(W);isNaN(g)&&(console.error("fn newWatch(): Invalid VIDEO_THUMBNAIL_SIZE in config.ts, using default size 300."),g=300);let h=I(V,{thumbnail:S,thumbnail_size:g.toString()});if(!!0){console.log("fn newWatch(): WATCHLIST_ENABLE is false, inserting at cursor..."),await a.insertAtCursor(`${d}${h}`),await a.flashNotification(`\u{1F3AC} ${i} - ${n} added with sucess!`);return}if(console.log(`fn newWatch(): $WATCHLIST_ENABLE = ${!0}, adding to watchlist...`),a.flashNotification("Saving watchlist to "+u),!await l.pageExists(u)){console.log(`fn newWatch(): Watchlist page does not exist in ${u}, creating...`);let y=await l.writePage(u,`${d}${h}`);console.log("fn newWatch(): Wrote page metadata:",y),await a.flashNotification(`\u{1F3AC} ${i} - ${n} added with sucess!`);return}console.log(`fn newWatch(): Watchlist page exists in ${u}, reading...`);let Z=await l.readPage(u);(await l.writePage(u,`${Z}
${d}${h}`)).created?(console.log(`fn newWatch(): Watchlist page created in ${u}.`),a.flashNotification(`\u{1F3AC} ${i} - ${n} added with sucess!`)):(console.log(`fn newWatch(): Some error creating watchlist page in ${u}.`),a.flashNotification(`new Failed to add ${i} - ${n} to watchlist.`))}function j(){console.log("exec fn deleteWatchlist(): description: Deletes the watchlist page."),l.deletePage(u).then(()=>{a.flashNotification("Watchlist deleted successfully.")}).catch(e=>{console.error("fn deleteWatchlist(): Error deleting watchlist.",e),a.flashNotification("Failed to delete watchlist.")})}async function K(){await q(),p.invokeCommand("System: Reload")}async function Q(){await j(),p.invokeCommand("System: Reload")}var Y={NewWatch:K,DeleteWatch:Q},z={name:"ytinfo",version:.11,requiredPermissions:["fetch"],functions:{NewWatch:{path:"ytinfo.ts:newWatch",command:{name:"Youtube: New Watch"}},DeleteWatch:{path:"ytinfo.ts:deleteWatch",command:{name:"Youtube: Delete All Watchlist"}}},assets:{}},$r={manifest:z,functionMapping:Y};D(Y,z,self.postMessage);export{$r as plug};
